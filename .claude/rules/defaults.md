# プロジェクト全体の開発ルール

このファイルは、Kakeibonプロジェクトでの開発時に常に適用されるルールを定義します。

## 基本方針

### セキュリティ優先

- **機密情報の保護**: `.env`ファイル、秘密鍵、認証情報には絶対にアクセスしない
- **SQLインジェクション対策**: ORMを使用し、生SQLクエリを避ける
- **XSS対策**: フロントエンドでのユーザー入力は適切にエスケープ

### コード品質

- **既存コードの理解**: 変更前に必ずファイルを読んで理解する
- **最小限の変更**: 要求された変更のみを行い、過度なリファクタリングを避ける
- **テスト**: 重要な機能変更には必ずテストを追加/更新

### コミュニケーション

- **不明点の確認**: 要件が曖昧な場合、必ずユーザーに確認
- **進捗報告**: TodoWriteツールで作業の進捗を可視化
- **変更の説明**: コミットメッセージには「なぜ」を記述

## Git運用ルール

### ブランチ戦略

- **mainブランチ**: 本番環境（直接コミット禁止）
- **devブランチ**: 開発環境（PRでマージ）
- **作業ブランチ**: `feature/`, `fix/`, `hotfix/` プレフィックス

### コミットルール

- **コミット頻度**: 論理的な単位で小まめにコミット
- **コミットメッセージ**: 日本語で明確に記述
  ```
  <変更の概要>

  <変更の理由や背景>

  Co-Authored-By: Claude Sonnet 4.5 <noreply@anthropic.com>
  ```
- **Amendの制限**: プッシュ済みコミットは修正しない

### Pull Request

- **PRのターゲット**: 基本的に `dev` ブランチ
- **PR説明**: Issueへのリンク、変更内容、テスト結果を記載
- **レビュー**: チームメンバーのレビューを待つ

## バックエンド開発ルール

### ディレクトリ構造

```
backend/app/
├── api/endpoints/   # APIエンドポイント
├── core/           # 設定、セキュリティ
├── models/         # SQLAlchemyモデル
├── schemas/        # Pydanticスキーマ
└── main.py         # エントリーポイント
```

### 開発手順

1. **モデル定義**: `app/models/` でSQLAlchemyモデルを作成
2. **スキーマ作成**: `app/schemas/` でPydanticスキーマを定義
3. **エンドポイント実装**: `app/api/endpoints/` でAPIを実装
4. **マイグレーション**: `uv run alembic revision --autogenerate -m "description"`
5. **テスト**: `pytest` で動作確認

### コーディング規約

- **型ヒント**: すべての関数に型ヒントを付ける
- **命名規則**:
  - クラス: PascalCase (`User`, `Transaction`)
  - 関数/変数: snake_case (`get_user`, `transaction_id`)
  - 定数: UPPER_SNAKE_CASE (`MAX_ITEMS`)
- **Pydantic**: バリデーションに必ず使用
- **非同期処理**: FastAPIでは async/await を適切に使用

## フロントエンド開発ルール

### ディレクトリ構造

```
frontend/src/
├── components/     # 再利用可能なコンポーネント
├── pages/         # ページコンポーネント
├── contexts/      # React Context
├── services/      # API通信
└── types/         # TypeScript型定義
```

### 開発手順

1. **型定義**: `src/types/` でTypeScript型を定義
2. **APIサービス**: `src/services/` でAPI通信ロジックを実装
3. **コンポーネント**: `src/components/` または `src/pages/` で実装
4. **ビルド確認**: `npm run build` でエラーチェック

### コーディング規約

- **型定義**: `any` 型を避け、適切な型を定義
- **命名規則**:
  - コンポーネント: PascalCase (`Dashboard`, `TransactionList`)
  - 関数/変数: camelCase (`getUserData`, `isLoading`)
  - 型/インターフェース: PascalCase (`User`, `Transaction`)
- **Hooks**: 関数コンポーネントとHooksを使用（クラスコンポーネント禁止）
- **Props型定義**: すべてのコンポーネントにProps型を定義

## データベース操作

### マイグレーション管理

- **自動生成**: `alembic revision --autogenerate` を基本とする
- **手動確認**: 生成されたマイグレーションファイルを必ず確認
- **ロールバック**: `alembic downgrade` は慎重に（データ損失の可能性）
- **テスト環境**: 本番前に必ずテスト環境でマイグレーションを実行

### クエリ最適化

- **N+1問題**: eager loadingを使用 (`joinedload`, `selectinload`)
- **インデックス**: 頻繁に検索されるカラムにインデックスを追加
- **ページネーション**: 大量データには必ずページネーションを実装

## テスト戦略

### バックエンド

- **ユニットテスト**: 個別の関数・メソッドをテスト
- **統合テスト**: APIエンドポイントの動作をテスト
- **カバレッジ目標**: 80%以上
- **実行**: `cd backend && pytest`

### フロントエンド

- **コンポーネントテスト**: 主要コンポーネントをテスト
- **カバレッジ目標**: 70%以上
- **実行**: `cd frontend && npm test`

## エラーハンドリング

### バックエンド

- **HTTPExceptionを使用**: FastAPIの標準例外を活用
- **適切なステータスコード**: 400, 401, 403, 404, 500など
- **エラーメッセージ**: ユーザーにわかりやすいメッセージ

### フロントエンド

- **try-catchブロック**: API呼び出しは必ずエラーハンドリング
- **ユーザーフィードバック**: エラー時は適切なメッセージを表示
- **ローディング状態**: API呼び出し中はローディング表示

## パフォーマンス

### バックエンド

- **データベースクエリ**: 不要なクエリを削減
- **非同期処理**: I/O操作は非同期に
- **キャッシング**: 頻繁にアクセスされるデータをキャッシュ

### フロントエンド

- **再レンダリング最適化**: `React.memo`, `useMemo`, `useCallback` を活用
- **コード分割**: 大きなコンポーネントはlazy loadを検討
- **画像最適化**: 適切なサイズと形式を使用

## ドキュメント

### コード内ドキュメント

- **複雑なロジック**: コメントで説明（自明なコードにはコメント不要）
- **Docstring**: Python関数には適切なdocstringを追加
- **JSDoc**: TypeScriptの複雑な関数にはJSDocを追加

### プロジェクトドキュメント

- **README.md**: プロジェクト概要と起動手順
- **doc/**: 詳細なドキュメント（git worktreeで管理）
- **.claude/CLAUDE.md**: プロジェクトの知識ベース

## トラブルシューティング

### よくある問題

1. **ポートが使用中**: `lsof -i :8000` でプロセスを確認
2. **マイグレーションエラー**: `alembic current` で状態確認
3. **npm installエラー**: `rm -rf node_modules && npm install`
4. **環境変数が読み込まれない**: `.env`ファイルの場所を確認

### 問題が解決しない場合

- エラーメッセージを確認
- ログファイルをチェック
- ユーザーに状況を報告して指示を仰ぐ

## まとめ

これらのルールは、プロジェクトの品質と一貫性を保つために定義されています。
状況に応じて柔軟に対応しつつ、基本原則は必ず守ってください。
